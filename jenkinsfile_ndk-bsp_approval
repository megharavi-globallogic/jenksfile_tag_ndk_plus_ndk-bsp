pipeline {
	agent none
	
	parameters {
    		string(name: 'version_release', defaultValue: '4.0.438.0', description: 'enter tag?')
  	}
	
	environment{
	vizio_tag_modules_download_artifactory_path="{vizio-dallas-megha-test/}"
	}
	
	options {
        timeout(time: 7, unit: 'DAYS')
    	}
	
    stages {
    	stage("Set version name"){
        	steps {
                	script {
                    		currentBuild.displayName = "${version_release}"
                	}
            	}
        }
	stage('QA Approval') {
		agent none
            	steps {
                	script {
                		println "${version_release}"
                   		def inputReleaseStatus
                    		def inputBUGS
				

                		def userInput = input(
                            	id: 'userInput', message: 'Enter the status of approval!',
                            	parameters: [
				    choice(name: 'APPROVALSTATUS', 
				    	    choices: 'APPROVED\nDEV-QA-DQed', 
					    description: "Are you releasing ${version_release} tag modules to EXTERNAL?"),
                                    string(defaultValue: 'NA',
                                            description: 'List of JIRA NUMBERS for issues found or any notes',
                                            name: 'BUGS')
				  
                            	])

                    		// Save to variables. Default to empty string if not found.
                    		env.inputReleaseStatus = userInput.APPROVALSTATUS?:''
                    		env.inputBUGS = userInput.BUGS?:''
				
                    
                    		println "$inputReleaseStatus"
                    		println "$inputBUGS"
			}
                	
        	}
	}
	stage("Delete_Artifacts"){
		agent any
		steps {
        		script {
			
				env.inputBUGS=sh (script: "echo $inputBUGS | sed 's/ /\\ /g'", returnStdout: true).trim()
				println "====$inputBUGS==="
				
				
				if ("${env.inputReleaseStatus}" == "APPROVED")
				{
					env.releaseVQA='APPROVED-TO-EXT'
					sh 'echo ==== QA approved the ${version_release} tag code ===='
					
				}
				else
                        	{
					env.releaseVQA='DEV-QA-DQed'
					sh '''
					echo "==== QA dqed the ${version_release} tag code ===="
					exit 1
					'''
				}
			}
		}
	}
	stage("Download_Artifacts"){
		agent any
		steps {
                	rtDownload (
                   	serverId: 'artifactory',
                   	spec:
                      		"""{
                           		"files": [
                               				{
                                 				"pattern":"${vizio_tag_modules_download_artifactory_path}", 
                               		  			"target":"${version_release}/${version_release}-ndk_bsp.tar.gz"
							}
					]
                        	}""",
                   		failNoOp: true
				
                	)
			//sh ' sudo mv ${version_release}-ndk_bsp.tar.gz ${version_release}-ndkbsp.tar.gz'
           	}
	}
	stage("Upload_Artifacts"){
		agent any
		steps {
			rtUpload (
                   	serverId: 'artifactory',
                   	spec:
                   		 """{
                   			    "files": [
                   			            	 {
                   			            	   "pattern": "${version_release}/${version_release}-ndk_bsp.tar.gz",
                   			              	   "target": "vizio-dallas-megha-test/ext/"
                   			            	 }
                   			             ]
                   		}""",
				failNoOp: true
                	)
		}
	}
	
    }
    post{ 
    	success {
		script {
			def success_attc = [
				[
					"type": "section",
					"text": [
						"type": "mrkdwn",
						"text": "successfully uploaded the ndk_plus_bsp ${version_release} tag file to External. click on the link below to download the required code"
					 ]
				]
        		]
      		}
    	}
   }
}
