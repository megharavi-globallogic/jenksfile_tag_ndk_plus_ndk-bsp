pipeline {
	agent none
    	environment {
		VERSION_RELEASE = '4.0.434.0'
		
		vizio_tag_modules_upload_artifactory_path_to_external = "vizio-dallas-megha-test/ext/"
		vizio_tag_modules_download_artifactory_path = "vizio-dallas-megha-test/${VERSION_RELEASE}/"
	}
	
	options {
        timeout(time: 7, unit: 'DAYS')
    	}
	
    stages {
    	stage("Set version name"){
        	steps {
                	script {
                    		currentBuild.displayName = "${VERSION_RELEASE}"
                	}
            	}
        }
	
    	stage('QA Approval') {
		agent none
            	steps {
                	script {
                		println "${VERSION_RELEASE}"
                   		def inputReleaseStatus
                    		def inputBUGS
				

                		def userInput = input(
                            	id: 'userInput', message: 'Enter the status of approval!',
                            	parameters: [
				    choice(name: 'APPROVALSTATUS', 
				    	    choices: 'APPROVED\nDEV-QA-DQed', 
					    description: "Are you releasing ${VERSION_RELEASE} tag modules to EXTERNAL?"),
                                    string(defaultValue: 'NA',
                                            description: 'List of JIRA NUMBERS for issues found or any notes',
                                            name: 'BUGS')
				  
                            	])

                    		// Save to variables. Default to empty string if not found.
                    		env.inputReleaseStatus = userInput.APPROVALSTATUS?:''
                    		env.inputBUGS = userInput.BUGS?:''
				
                    
                    		println "$inputReleaseStatus"
                    		println "$inputBUGS"
			}
                	
        	}
	}
	stage("Delete_Artifacts"){
		agent any
		steps {
        		script {
			
				env.inputBUGS=sh (script: "echo $inputBUGS | sed 's/ /\\ /g'", returnStdout: true).trim()
				println "====$inputBUGS==="
				
				
				if ("${env.inputReleaseStatus}" == "APPROVED")
				{
					env.releaseVQA='APPROVED-TO-EXT'
					sh 'echo ==== QA approved the ${VERSION_RELEASE} tag code ===='
					
				}
				else
                        	{
					env.releaseVQA='DEV-QA-DQed'
					sh '''
					echo "==== QA dqed the ${VERSION_RELEASE} tag code ===="
					exit 1
					'''
				}
			}
		}
	}
	stage("Download_Artifacts"){
		agent any
		steps {
                	rtDownload (
                   	serverId: 'artifactory',
                   	spec:
                      		"""{
                           		"files": [
                               				{
                                 				"pattern":"${vizio_tag_modules_download_artifactory_path}", 
                               		  			"target":"${VERSION_RELEASE}-ndk_bsp.tar.gz"
							}
					]
                        	}""",
                   		failNoOp: true
                	)
           	}
	}
	stage("Upload_Artifacts"){
		agent any
		steps {
			rtUpload (
                   	serverId: 'artifactory',
                   	spec:
                   		 """{
                   			    "files": [
                   			            	 {
                   			            	   "pattern": "${VERSION_RELEASE}-ndk_bsp.tar.gz",
                   			              	   "target": "${vizio_tag_modules_upload_artifactory_path_to_external}/${VERSION_RELEASE}"
                   			            	 }
                   			             ]
                   		}"""
				failNoOp: true
                	)
		}
	}
	
    }
    post{ 
    	success {
		script {
			def success_attc = [
				[
					"type": "section",
					"text": [
						"type": "mrkdwn",
						"text": "successfully uploaded the ndk_plus_bsp ${version_release} tag file to External. click on the link below to download the required code"
					 ]
				],
				[
					"type": "section",
					"text": [
						"type": "mrkdwn",
						"text": ":small_blue_diamond: :sparkles: *Released Tag: ${VERSION_RELEASE}* :sparkles: :small_blue_diamond:"
					 ]
				]
        		]
      		}
    	}
   }
}
